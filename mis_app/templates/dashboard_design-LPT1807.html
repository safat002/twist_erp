{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard: {{ dashboard.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@9.3.0/dist/gridstack.min.css" />
<link rel="stylesheet" href="{% static 'css/dashboard_designer.css' %}" />
{% endblock %}

{% block content %}
<div class="dashboard-container" data-dashboard-id="{{ dashboard.id }}">
    
    {% csrf_token %}

    <header class="dashboard-header">
        <div class="header-left">
            <h4 class="dashboard-title mb-0">{{ dashboard.title }}</h4>
        </div>
        <div class="header-right">
            <div class="action-group">
                <button id="refreshAllBtn" title="Refresh All Widgets" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-repeat"></i>
                </button>
                <button id="shareBtn" title="Share" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#shareModal">
                    <i class="bi bi-share"></i>
                </button>
                <button id="exportBtn" title="Export" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#exportModal">
                    <i class="bi bi-download"></i>
                </button>
            </div>
            <div class="vr"></div>
            <div class="action-group">
                <button id="undoBtn" title="Undo" class="btn btn-outline-secondary" disabled>
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
                <button id="redoBtn" title="Redo" class="btn btn-outline-secondary" disabled>
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="vr"></div>
            <button id="saveDashboardBtn" class="btn btn-primary">
                <i class="bi bi-save me-2"></i>Save Changes
            </button>
        </div>
    </header>

    <div class="dashboard-toolbar">
        <div class="toolbar-section">
            <span class="toolbar-label">Filters:</span>
            <button class="btn btn-sm btn-outline-secondary" id="add-filter-btn" title="Add global filter">
            <i class="bi bi-plus-lg"></i>
        </button>
            <div id="global-filter-chips" class="d-flex gap-2 align-items-center"></div>
        </div>
        <div class="toolbar-section">
            
            <label for="colorThemeSelector" class="toolbar-label">Theme:</label>
            <select class="form-select form-select-sm" id="colorThemeSelector" style="width: auto;">
                <option value="Tableau.Classic10">Tableau Classic</option>
                <option value="brewer.Pastel1-9">Pastel</option>
                <option value="office.Office6">Office</option>
                <option value="tableau.Tableau20">Tableau 20</option>
            </select>
        </div>
    </div>

    <div class="dashboard-body">
        <aside class="dashboard-sidebar">
            <ul class="nav nav-tabs nav-fill" id="sidebar-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="widgets-tab-btn" data-bs-toggle="tab" data-bs-target="#widgets-pane" type="button">
                        <i class="bi bi-puzzle me-1"></i> Widgets
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="data-tab-btn" data-bs-toggle="tab" data-bs-target="#data-pane" type="button">
                        <i class="bi bi-table me-1"></i> Data
                    </button>
                </li>
            </ul>
            <div class="tab-content flex-grow-1 overflow-auto">
                <div class="tab-pane fade show active p-3" id="widgets-pane">
                    <div id="widget-palette" class="widget-palette"></div>
                </div>
                <div class="tab-pane fade p-3" id="data-pane">
                    <h6>Available Fields</h6>
                    <div id="available-fields-list" class="available-fields-list">
                        <div class="text-muted small p-3 text-center">
                            Configure data to see fields.
                        </div>
                    </div>
                </div>
            </div>
            <div class="sidebar-footer">
                <button id="manageDataContextBtn" class="btn btn-outline-primary w-100">
                    <i class="bi bi-database-gear me-2"></i>Configure Data
                </button>
            </div>
        </aside>

        <main class="dashboard-main">
            <div class="grid-stack flex-grow-1" id="dashboard-grid">
                </div>
        </main>
    </div>
</div>

{% comment %}
    We will create the content for these modals in later steps.
    For now, including them ensures the buttons in the header will work.
{% endcomment %}
{% include 'partials/data_context_modal.html' %}
{% include 'partials/widget_settings_modal.html' %}
{% include 'partials/global_filter_modal.html' %}
{% include 'partials/export_modal.html' %}
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="appToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle"></strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gridstack@9.3.0/dist/gridstack-all.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script src="{% static 'js/event_bus.js' %}"></script>
<script src="{% static 'js/color_service.js' %}"></script>
<script src="{% static 'js/dashboard_designer.js' %}"></script>
<script src="{% static 'js/export_service.js' %}"></script>
<script src="{% static 'js/widget_renderer.js' %}"></script>
{% endblock %}