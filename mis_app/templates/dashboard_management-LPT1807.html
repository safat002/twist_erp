{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard Management{% endblock %}

{% block extra_css %}
<style>
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
  }
  .dashboard-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  }
  .dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
  }
  .card-footer {
    background-color: transparent;
    border-top: 1px solid #f0f0f0;
  }
  .empty-state {
    grid-column: 1 / -1; /* Span all columns */
    text-align: center;
    padding: 3rem;
    border: 2px dashed #e9ecef;
    border-radius: 0.5rem;
  }
  .page-container {
  display: flex;
  height: 100vh; /* Make it fill the full viewport height */
}

/* This styles the blue sidebar */
.primary-sidebar {
  width: 65px; /* Give the sidebar a fixed width */
  flex-shrink: 0; /* Prevent the sidebar from shrinking */
  background-color: #0d6efd; /* Your blue color */
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 1rem;
}

/* This is the wrapper for the top navbar and main content */
.page-content-wrapper {
  flex-grow: 1; /* Allow this container to grow and fill the remaining space */
  display: flex;
  flex-direction: column;
  overflow: hidden; /* Prevents layout issues */
}

/* Ensure the main content area can scroll if needed */
main.flex-grow-1 {
    overflow-y: auto;
    padding: 1.5rem;
}

/* Styling for the icons inside the sidebar */
.sidebar-icon {
  color: rgba(255, 255, 255, 0.7);
  font-size: 1.5rem;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
  border-radius: 0.375rem;
  transition: background-color 0.2s ease, color 0.2s ease;
}

.sidebar-icon:hover, .sidebar-icon.active {
  background-color: rgba(255, 255, 255, 0.15);
  color: #ffffff;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
  {% csrf_token %}
  <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
    <h1 class="mb-0">Dashboard Management</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDashboardModal">
      <i class="bi bi-plus-lg me-2"></i>Create New Dashboard
    </button>
  </div>

  <section id="all-dashboards">
    <h4 class="mb-3">All Dashboards</h4>
    <div class="dashboard-grid">
      {% for dash in owned_dashboards %}
      <div class="card dashboard-card">
        <div class="card-body">
          <h5 class="card-title">
            <a href="{% url 'mis_app:dashboard_design' dashboard_id=dash.id %}" class="text-decoration-none stretched-link">{{ dash.title }}</a>
          </h5>
          <p class="card-subtitle mb-2 text-muted small">Owned by: {{ dash.owner.username }}</p>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
           <a href="#" class="btn btn-sm btn-outline-danger">Delete</a>
           <a href="#" class="btn btn-sm btn-outline-secondary">Pin</a>
        </div>
      </div>
      {% empty %}
        <div class="empty-state">
          <p class="mb-0 text-muted">You haven't created any dashboards yet. Click the button above to get started.</p>
        </div>
      {% endfor %}
    </div>
  </section>
</div>

<div class="modal fade" id="createDashboardModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Dashboard</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="newDashboardName" class="form-label">Dashboard Name</label>
        <input type="text" class="form-control" id="newDashboardName" placeholder="e.g., Q3 Sales Performance" required />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmCreateDashboardBtn">Create</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    const createBtn = document.getElementById('confirmCreateDashboardBtn');
    const modalElement = document.getElementById('createDashboardModal');
    const modal = new bootstrap.Modal(modalElement);

    createBtn.addEventListener('click', function() {
        const dashboardNameInput = document.getElementById('newDashboardName');
        const dashboardName = dashboardNameInput.value.trim();

        if (!dashboardName) {
            alert('Please enter a dashboard name.');
            dashboardNameInput.focus();
            return;
        }

        fetch("{% url 'mis_app:create_dashboard_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ dashboard_name: dashboardName })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Redirect to the new dashboard's design page
                window.location.href = `/dashboard/design/${data.dashboard_id}/`;
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred. Check the console for details.');
        });
    });
});
</script>
{% endblock %}