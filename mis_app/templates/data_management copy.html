{% extends "base.html" %}
{% load static %}

{% block title %}Data Management{% endblock %}

{% block extra_css %}
<style>
  .wizard-card {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }
  .wizard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .danger-zone .card-header {
      background-color: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
  }
  #columnDefinitionContainer .row {
    border-bottom: 1px solid #eee;
    padding-bottom: 0.5rem;
    margin-bottom: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Data Management</h1>
    <div class="col-md-5">
      <label for="connectionSelect" class="form-label"><strong>Active Database Connection</strong></label>
      <select id="connectionSelect" class="form-select">
        {% if connections %}
          {% for conn in connections %}
            <option value="{{ conn.id }}" {% if conn.id == initial_connection_id %}selected{% endif %}>
              {{ conn.nickname }} ({{ conn.db_type }})
            </option>
          {% endfor %}
        {% else %}
          <option value="">No connections available. Please contact an administrator.</option>
        {% endif %}
      </select>
    </div>
  </div>

  <ul class="nav nav-tabs" id="dataTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="viewer-tab" data-bs-toggle="tab" data-bs-target="#viewer-pane" type="button">Table Viewer</button>
    </li>
    {% if user_can_upload %}
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="uploader-tab" data-bs-toggle="tab" data-bs-target="#uploader-pane" type="button">Upload Data</button>
    </li>
    {% endif %}
    {% if user_can_modify %}
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-pane" type="button">Create Table</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="modify-tab" data-bs-toggle="tab" data-bs-target="#modify-pane" type="button">Modify Table</button>
    </li>
    {% endif %}
  </ul>

  <div class="tab-content" id="dataTabsContent">
    <div class="tab-pane fade show active" id="viewer-pane" role="tabpanel">
      <div class="card card-body border-top-0 rounded-bottom">
        <div class="row g-3 mb-3 align-items-center">
          <div class="col-md-5">
            <label for="viewTableSelect" class="form-label mb-0"><strong>Select a Table to View</strong></label>
            <select class="form-select mt-1" id="viewTableSelect"></select>
          </div>
           <div class="col-md-4">
            {% if user_can_modify %}
            <div class="pt-4">
              <button class="btn btn-outline-danger" id="deleteRowsBtn" disabled><i class="bi bi-trash-fill me-2"></i>Delete Selected Rows (<span id="deleteRowCount">0</span>)</button>
            </div>
            {% endif %}
          </div>
        </div>
        <div id="tableViewerContainer" class="table-responsive">
          <div class="text-center text-muted p-5">Please select a table to view its data.</div>
        </div>
      </div>
    </div>

    {% if user_can_upload %}
    <div class="tab-pane fade" id="uploader-pane" role="tabpanel">
      <div class="card card-body border-top-0 rounded-bottom" id="uploadWizardContainer"></div>
    </div>
    {% endif %}

    {% if user_can_modify %}
    <div class="tab-pane fade" id="create-pane" role="tabpanel">
      <div class="card card-body border-top-0 rounded-bottom" id="createWizardContainer"></div>
    </div>
    <div class="tab-pane fade" id="modify-pane" role="tabpanel">
      <div class="card card-body border-top-0 rounded-bottom">
        <div class="mb-3 col-md-6">
          <label for="modifyTableSelect" class="form-label"><strong>Select a Table to Modify</strong></label>
          <select class="form-select" id="modifyTableSelect"></select>
        </div>
        <div id="modificationContainer" style="display:none;">
          <hr/>
          <div class="card mb-4"><div class="card-header"><h5>General</h5></div>
            <div class="card-body">
              <label for="newTableNameInput" class="form-label"><strong>Rename Table</strong></label>
              <div class="input-group">
                <input type="text" id="newTableNameInput" class="form-control" placeholder="Enter new table name">
                <button class="btn btn-primary" id="renameTableBtn">Save New Name</button>
              </div>
            </div>
          </div>
          <div class="card mb-4"><div class="card-header"><h5>Manage Columns</h5></div>
            <div class="card-body"><div id="columnManagementContainer"></div></div>
          </div>
          <div class="card danger-zone"><div class="card-header"><h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Danger Zone</h5></div>
            <div class="card-body">
              <p>These actions are permanent and have significant consequences. Please be certain.</p>
              <div class="d-flex gap-2">
                <button class="btn btn-warning" id="truncateTableBtn">Delete All Data (Truncate)...</button>
                <button class="btn btn-danger" id="dropTableBtn">Delete Entire Table (Drop)...</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<div class="modal fade" id="passwordConfirmModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="passwordConfirmTitle"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="passwordConfirmWarning" class="fw-bold"></p>
        <div class="mb-3">
          <label for="confirmText" id="confirmTextLabel" class="form-label"></label>
          <input type="text" id="confirmText" class="form-control">
        </div>
        <div class="mb-3">
          <label for="userPassword" class="form-label">Enter Your Password to Authorize</label>
          <input type="password" id="userPassword" class="form-control" autocomplete="current-password">
        </div>
        <div id="passwordConfirmError" class="alert alert-danger" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmActionBtn" disabled>I Understand, Proceed</button>
      </div>
  </div></div>
</div>

<div class="modal fade" id="modifyColumnModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modify Column: <span id="modifyColumnName"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="originalColumnName">
        <input type="hidden" id="originalColumnType"> <div class="mb-3">
          <label for="newColumnNameInput" class="form-label">Column Name</label>
          <input type="text" class="form-control" id="newColumnNameInput">
        </div>
        <div class="mb-3">
          <label for="columnDataTypeSelect" class="form-label">Data Type</label>
          <select id="columnDataTypeSelect" class="form-select">
            <option value="VARCHAR(255)">Text</option>
            <option value="INTEGER">Integer</option>
            <option value="FLOAT">Decimal</option>
            <option value="DATE">Date</option>
            <option value="TIMESTAMP">Date & Time</option>
            <option value="BOOLEAN">True/False</option>
          </select>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-outline-danger" id="dropColumnBtn">Delete Column</button>
        <div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveColumnChangesBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{# We now point to the Django static file path #}
<script src="{% static 'js/data_management.js' %}"></script>
{% endblock %}