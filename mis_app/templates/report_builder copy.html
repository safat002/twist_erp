{% extends "base.html" %}
{% load static %}

{% block title %}Report Builder{% endblock %}

{% block extra_css %}
<link href="{% static 'css/report_builder.css' %}" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/sortablejs/1.15.0/sortable.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid report-builder-container">
    <!-- Header Section -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Report Builder</h1>
                    <small class="text-muted" id="reportNameDisplay">New Report</small>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" id="loadReportBtn" title="Load Report">
                        <i class="fas fa-folder-open"></i> Load
                    </button>
                    <button type="button" class="btn btn-outline-success" id="saveAsReportBtn" title="Save As New">
                        <i class="fas fa-save"></i> Save As
                    </button>
                    <button type="button" class="btn btn-outline-info" id="updateReportBtn" title="Update Current">
                        <i class="fas fa-sync"></i> Update
                    </button>
                    <div class="btn-group" role="group">
                        <button id="exportMenuBtn" type="button" class="btn btn-outline-secondary dropdown-toggle" 
                                data-bs-toggle="dropdown" aria-expanded="false" title="Export Options">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="exportExcelBtn">
                                <i class="fas fa-file-excel text-success"></i> Excel
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="exportCsvBtn">
                                <i class="fas fa-file-csv text-primary"></i> CSV
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="exportPdfBtn">
                                <i class="fas fa-file-pdf text-danger"></i> PDF
                            </a></li>
                        </ul>
                    </div>
                    <button type="button" class="btn btn-primary" id="refreshReportBtn" title="Generate Report">
                        <i class="fas fa-play"></i> Run Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Sidebar - Data Sources -->
        <div class="col-lg-3 rb-sidebar-left">
            <div class="card h-100">
                <div class="card-header rb-sidebar-header bg-light" style="cursor: pointer;">
                    <h6 class="mb-0">
                        <i class="fas fa-database me-2"></i>Data Sources
                        <i class="fas fa-chevron-up float-end d-lg-none" id="dataSourceChevron"></i>
                    </h6>
                </div>
                <div class="card-body p-2 rb-sidebar-content">
                    <!-- Connection Selection -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Connection</label>
                        <select class="form-select form-select-sm" id="connectionSelect">
                            <option value="">Select connection...</option>
                            {% for conn in connections %}
                            <option value="{{ conn.id }}">{{ conn.nickname }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Search Tables -->
                    <div class="mb-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="dataSourceSearch" 
                                   placeholder="Search tables...">
                        </div>
                    </div>

                    <!-- Tables and Columns -->
                    <div class="accordion accordion-flush" id="dataSourceAccordion">
                        <!-- Dynamic content loaded here -->
                    </div>

                    <!-- Calculated Fields Section -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 small text-muted">Calculated Fields</h6>
                            <button class="btn btn-sm btn-outline-primary" id="addCalculatedFieldBtn" title="Add Calculated Field">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="calculatedFieldsList">
                            <!-- Calculated fields will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-lg-9">
            <div class="card">
                <!-- Configuration Panel -->
                <div class="card-header bg-light" id="configHeader" style="cursor: pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>Query Configuration
                        </h6>
                        <button type="button" class="btn btn-sm btn-link p-0" id="toggleConfigBtn">
                            <i class="fas fa-chevron-up" id="configChevron"></i>
                        </button>
                    </div>
                </div>

                <div class="card-body collapse show" id="queryBuilder">
                    <!-- Action Buttons -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary action-btn" data-section="columns">
                                    <i class="fas fa-columns"></i> Columns
                                </button>
                                <button class="btn btn-outline-info action-btn" data-section="filters">
                                    <i class="fas fa-filter"></i> Filters
                                </button>
                                <button class="btn btn-outline-success action-btn" data-section="groups">
                                    <i class="fas fa-layer-group"></i> Groups
                                </button>
                                <button class="btn btn-outline-warning action-btn" data-section="sorts">
                                    <i class="fas fa-sort"></i> Sorts
                                </button>
                                <button class="btn btn-outline-secondary action-btn" data-section="joins">
                                    <i class="fas fa-link"></i> Joins
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Drop Zones -->
                    <div class="row g-3">
                        <!-- Columns -->
                        <div class="col-md-6">
                            <div class="drop-zone-container">
                                <label class="form-label fw-bold small">
                                    <i class="fas fa-columns text-primary"></i> Columns
                                </label>
                                <div class="drop-zone" id="columnsBox" data-type="columns">
                                    <div class="drop-zone-placeholder">
                                        <i class="fas fa-columns"></i>
                                        <span>Drag columns here</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="col-md-6">
                            <div class="drop-zone-container">
                                <label class="form-label fw-bold small">
                                    <i class="fas fa-filter text-info"></i> Filters
                                </label>
                                <div class="drop-zone" id="filtersBox" data-type="filters">
                                    <div class="drop-zone-placeholder">
                                        <i class="fas fa-filter"></i>
                                        <span>Drag filters here</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Groups -->
                        <div class="col-md-6">
                            <div class="drop-zone-container">
                                <label class="form-label fw-bold small">
                                    <i class="fas fa-layer-group text-success"></i> Groups
                                </label>
                                <div class="drop-zone" id="groupBox" data-type="groups">
                                    <div class="drop-zone-placeholder">
                                        <i class="fas fa-layer-group"></i>
                                        <span>Drag groups here</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sorts -->
                        <div class="col-md-6">
                            <div class="drop-zone-container">
                                <label class="form-label fw-bold small">
                                    <i class="fas fa-sort text-warning"></i> Sorts
                                </label>
                                <div class="drop-zone" id="sortsBox" data-type="sorts">
                                    <div class="drop-zone-placeholder">
                                        <i class="fas fa-sort"></i>
                                        <span>Drag sorts here</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Joins Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="drop-zone-container">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label class="form-label fw-bold small mb-0">
                                        <i class="fas fa-link text-secondary"></i> Joins
                                    </label>
                                    <button class="btn btn-sm btn-outline-secondary" id="addJoinBtn" title="Add Join">
                                        <i class="fas fa-plus"></i> Add Join
                                    </button>
                                </div>
                                <div class="drop-zone mt-2" id="joinsBox" data-type="joins">
                                    <div class="drop-zone-placeholder">
                                        <i class="fas fa-link"></i>
                                        <span>Configure table joins here</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Filters -->
                    <div class="row mt-3" id="userFilterControls" style="display: none;">
                        <div class="col-12">
                            <div class="card border-info">
                                <div class="card-header bg-info bg-opacity-10">
                                    <h6 class="mb-0">
                                        <i class="fas fa-sliders-h me-2"></i>Interactive Filters
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="dynamicFilterContainer">
                                        <!-- Dynamic filter controls will be rendered here -->
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-primary" id="applyFiltersBtn">
                                            <i class="fas fa-check"></i> Apply Filters
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" id="toggleFiltersBtn">
                                            <i class="fas fa-eye-slash"></i> Hide Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="card-body border-top">
                    <!-- Action Bar -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-info me-2" id="toggleFiltersBtn" title="Toggle Filters">
                                    <i class="fas fa-sliders-h"></i> Filters
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" id="drillBackBtn" style="display: none;" title="Drill Back">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-flex justify-content-end align-items-center">
                                <span class="text-muted small me-3" id="resultsInfo">
                                    <!-- Results info will be displayed here -->
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Results Table -->
                    <div id="resultsContainer" class="table-responsive">
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <h5>Ready to Build Your Report</h5>
                            <p>Configure your data sources and click "Run Report" to see results</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div id="paginationContainer" class="d-flex justify-content-center mt-3" style="display: none !important;">
                        <nav>
                            <ul class="pagination pagination-sm" id="paginationList">
                                <!-- Pagination will be rendered here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastBody">
            <!-- Toast message -->
        </div>
    </div>
</div>

<!-- Load Report Modal -->
<div class="modal fade" id="loadReportModal" tabindex="-1" aria-labelledby="loadReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loadReportModalLabel">
                    <i class="fas fa-folder-open me-2"></i>Load Saved Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="loadReportModalBody">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Report Modal -->
<div class="modal fade" id="saveReportModal" tabindex="-1" aria-labelledby="saveReportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveReportModalLabel">
                    <i class="fas fa-save me-2"></i>Save Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="reportName" class="form-label">Report Name</label>
                    <input type="text" class="form-control" id="reportName" placeholder="Enter report name">
                    <div class="form-text">Choose a descriptive name for your report</div>
                </div>
                <div class="mb-3">
                    <label for="reportDescription" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="reportDescription" rows="3" 
                              placeholder="Brief description of this report"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveReport">
                    <i class="fas fa-save me-2"></i>Save Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Share Report Modal -->
<div class="modal fade" id="shareReportModal" tabindex="-1" aria-labelledby="shareReportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareReportModalLabel">
                    <i class="fas fa-share-alt me-2"></i>Share Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Add User</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="shareUserInput" placeholder="Enter username or email">
                        <button class="btn btn-outline-primary" type="button" id="addUserShareBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                <div id="currentShares">
                    <!-- Current shares will be displayed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSharesBtn">
                    <i class="fas fa-save me-2"></i>Save Shares
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Formatting Modal -->
<div class="modal fade" id="formattingModal" tabindex="-1" aria-labelledby="formattingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formattingModalLabel">
                    <i class="fas fa-palette me-2"></i>Format Column
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="columnFormatType" class="form-label">Format Type</label>
                    <select class="form-select" id="columnFormatType">
                        <option value="none">No Formatting</option>
                        <option value="number">Number</option>
                        <option value="currency">Currency</option>
                        <option value="percentage">Percentage</option>
                        <option value="date">Date</option>
                        <option value="datetime">Date & Time</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
                <div id="formatOptions" class="mb-3" style="display: none;">
                    <!-- Format-specific options will be shown here -->
                </div>

                <div class="mb-3">
                    <label for="formatPreview" class="form-label">Preview</label>
                    <div class="form-control" id="formatPreview" style="background-color: #f8f9fa;">
                        Sample formatting will appear here
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyFormatting">
                    <i class="fas fa-check me-2"></i>Apply Formatting
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Calculated Field Modal -->
<div class="modal fade" id="calculatedFieldModal" tabindex="-1" aria-labelledby="calculatedFieldModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calculatedFieldModalLabel">
                    <i class="fas fa-calculator me-2"></i>Create Calculated Field
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="calcFieldName" class="form-label">Field Name</label>
                            <input type="text" class="form-control" id="calcFieldName" placeholder="Enter field name">
                        </div>
                        <div class="mb-3">
                            <label for="calcFieldDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="calcFieldDescription" rows="2" 
                                      placeholder="Brief description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Available Fields</label>
                            <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;" id="availableFieldsList">
                                <!-- Available fields will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="calcFieldFormula" class="form-label">Formula</label>
                            <textarea class="form-control font-monospace" id="calcFieldFormula" rows="8" 
                                      placeholder="Enter your formula using [Table.Column] syntax"></textarea>
                            <div class="form-text">Use [Table.Column] to reference fields</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Common Operators</label>
                            <div class="btn-group-vertical d-grid gap-1">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary operator-btn" data-op="+">+</button>
                                    <button type="button" class="btn btn-outline-secondary operator-btn" data-op="-">-</button>
                                    <button type="button" class="btn btn-outline-secondary operator-btn" data-op="*">Ã—</button>
                                    <button type="button" class="btn btn-outline-secondary operator-btn" data-op="/">/</button>
                                </div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary operator-btn" data-op="SUM">SUM</button>
                                    <button type="button" class="btn btn-outline-secondary operator-btn" data-op="AVG">AVG</button>
                                    <button type="button" class="btn btn-outline-secondary operator-btn" data-op="COUNT">COUNT</button>
                                </div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary operator-btn" data-op="CASE WHEN">CASE</button>
                                    <button type="button" class="btn btn-outline-secondary operator-btn" data-op="ROUND">ROUND</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCalculatedField">
                    <i class="fas fa-save me-2"></i>Save Field
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Data Prep Workflow Modal -->
<div class="modal fade" id="dataPrepModal" tabindex="-1" aria-labelledby="dataPrepModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dataPrepModalLabel">
                    <i class="fas fa-tools me-2"></i>Data Preparation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Data Prep content will be loaded here -->
                <div id="dataPrepContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading data preparation tools...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/sortablejs/1.15.0/Sortable.min.js"></script>

<script>
    const csrfToken = '{{ csrf_token }}';
    
    // Correct Django URLs for the report builder
    const URLS = {
    // Core URLs
    connections: '{% url "mis_app:api_connections" %}',
    executeReport: '{% url "mis_app:execute_report_api" %}',
    saveReport: '{% url "mis_app:save_report_api" %}',
    loadReports: '{% url "mis_app:get_my_reports_api" %}',
    
    // Dynamic URLs (built in JS)
    tables: (connId) => `/api/data/visible-tables/${connId}/`,
    tableColumns: (connId, tableName) => `/api/data/get-columns-for-table/${connId}/${tableName}/`,
    reportDetail: (reportId) => `/api/reports/${reportId}/`,

    // URLs for upcoming features (we will build these views next)
    exportReport: '{% url "mis_app:export_report_api" %}',
    checkJoinPath: '{% url "mis_app:check_join_path" %}',
};
</script>

<script src="{% static 'js/report_builder_django.js' %}"></script>
{% endblock %}