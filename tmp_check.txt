from __future__ import annotations

from collections import defaultdict
from decimal import Decimal

from django.db import models
from django.db.models import Count, F, Max, Sum
from django.db.models.functions import Coalesce
from django.utils import timezone
from rest_framework import mixins, serializers, status, viewsets
from django.conf import settings
from django.db import IntegrityError, DatabaseError
from rest_framework.decorators import action
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework.views import APIView

from apps.audit.utils import log_audit_event

from .models import (
    Budget,
    BudgetConsumptionSnapshot,
    BudgetLine,
    BudgetOverrideRequest,
    BudgetUsage,
    CostCenter,
    BudgetItemCode,
    BudgetItemCategory,
    BudgetItemSubCategory,
    BudgetRemarkTemplate,
    BudgetVarianceAudit,
    BudgetApproval,
    BudgetApprovalLine,
)
from .serializers import (
    BudgetLineSerializer,
    BudgetOverrideRequestSerializer,
    BudgetSerializer,
    BudgetSnapshotSerializer,
    BudgetUsageSerializer,
